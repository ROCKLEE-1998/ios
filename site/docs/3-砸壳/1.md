# å‰è¨€
> ç ¸å£³åŸç†å°è®°ï¼šåˆ†ædumpdecryptedæºç ä»¥åŠClutchã€frida-ios-dumpã€CrackerXIç ¸å£³å·¥å…·çš„ä½¿ç”¨ã€‚

ç”¨ä¸€å¥è¯æ€»ç»“ç½‘ä¸Šæ–‡ç« å¯¹ç ¸å£³çš„è§£é‡Šï¼š`AppStore`Â å‘å¸ƒçš„ App éƒ½æ˜¯åŠ å£³ï¼ˆ[FairPlay DRM](https://tech.meituan.com/2021/11/25/fairplay-drm.html)ï¼‰åçš„ `ipa` æ–‡ä»¶ï¼Œé€†å‘Appå°±å¾—å…ˆç ¸å£³ï¼Œåœ¨iOSç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç ¸å£³æ‰€ä½¿ç”¨çš„éƒ½æ˜¯åŠ¨æ€ç ¸å£³æŠ€æœ¯ï¼Œå³ä»è¿è¡Œåœ¨è¿›ç¨‹å†…å­˜ç©ºé—´ä¸­çš„å¯æ‰§è¡Œç¨‹åºæ˜ åƒï¼ˆimageï¼‰å…¥æ‰‹ï¼Œå°†å†…å­˜ä¸­çš„å†…å®¹è¿›è¡Œè½¬å‚¨ï¼ˆdumpï¼‰å¤„ç†æ¥å®ç°è„±å£³å¤„ç†ã€‚è¿™ç§æ–¹æ³•å®ç°èµ·æ¥ç›¸å¯¹ç®€å•ï¼Œä¸”ä¸å¿…å…³å¿ƒä½¿ç”¨çš„æ˜¯ä½•ç§åŠ å¯†æŠ€æœ¯ã€‚

## å‡†å¤‡

1. [è¶Šç‹±](/docs/1-è¶Šç‹±)
2. Cydiaå·¥å…·å®‰è£…
    - `OpenSSH`
    - `Darwin cc tools`
3. ä¸‹è½½App
    - åœ¨ AppStore éšä¾¿æ‰¾ä¸ªApp

`AppStore`ä¸‹è½½çš„Appåœ¨`/var/containers/Bundle/Application/$uuid` ç›®å½•ä¸‹ï¼Œæ‰¾åˆ°åˆšæ‰ä¸‹è½½çš„Appï¼Œé€šè¿‡æŸ¥çœ‹`cryptid`æ ‡å¿—ä½æ¥åˆ¤æ–­AppåŠ å¯†çŠ¶æ€ã€‚å…¶ä¸­1ä»£è¡¨åŠ å¯†ï¼Œ0ä»£è¡¨å·²è§£å¯†ï¼š

```bash
$ otool -lv /var/containers/Bundle/Application/xxxxx-xxxx-xxxx-xxxx-xxxxx/Foo.app/Foo | egrep 'LC_ENCRYPTION_INFO|cryptid'
          cmd LC_ENCRYPTION_INFO_64
      cryptid 1
```

å¦‚æœAppæ²¡æœ‰è¢«åŠ å¯†ï¼Œåˆ™ç›´æ¥äº¤ç»™dyldåŠ è½½å¹¶ä¸”è¿è¡Œã€‚å¦‚æœAppå·²ç»è¢«åŠ å¯†ï¼Œåˆ™éœ€è¦å†…æ ¸å¯¹å…¶è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°è§£å¯†åçš„MachOæ–‡ä»¶ï¼Œå†å°†å…¶äº¤ç»™dyldåŠ è½½å¹¶è¿è¡Œã€‚

å†æŠŠåŠ å¯†çš„ macho ç”¨ MachOView æ‰“å¼€çœ‹åˆ°Load Commands ä¸­æœ‰`LC_ENCRYPTION_INFO` çš„`Crypt ID` ä¸º 1 å’Œä¸Šé¢otoolå‘½ä»¤æŸ¥çœ‹çš„å†…å®¹ä¸€è‡´ï¼š

![](../assets/images/dump-machoview.png)

Hopper æ‰“å¼€æ‰¾åˆ°å…¥å£ï¼Œä¼šæç¤ºè¿™æ˜¯ä¸ªåŠ å¯†æ–‡ä»¶ï¼š

![](../assets/images/dump-hopper.png)

æ¥ä¸‹æ¥å°±æ˜¯å¯¹ App è¿›è¡Œç ¸å£³ï¼Œç›®å‰å¸¸è§çš„ç ¸å£³å·¥å…·å¦‚ä¸‹ï¼š

- [dumpdecrypted](https://github.com/stefanesser/dumpdecrypted)
- [Clutch](https://github.com/KJCracks/Clutch)
- [frida-ios-dump](https://github.com/AloneMonkey/frida-ios-dump)
- CrackerXI+

## åˆä»£ç ¸å£³å·¥å…·

å…ˆä»åˆä»£ç ¸å£³å·¥å…· [stefanesser - dumpdecrypted](https://github.com/stefanesser/dumpdecrypted) çš„æºç æ¢ç©¶ä¸€ä¸‹ç ¸å£³å¦‚ä½•å®ç°çš„ã€‚

### æºç åˆ†æ

ä»è¿è¡Œå‘½ä»¤ `$ DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/mobile/Applications/xxx-xxxx-xxxx/Scan.app/Scan` çœ‹å‡ºè¿™æ˜¯åˆ©ç”¨æ³¨å…¥åŠ¨æ€åº“çš„æ–¹å¼ï¼Œ`__attribute__((constructor))` æ˜¯GCC è¯­æ³•ï¼Œå½“ä¸å‡½æ•°ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶åœ¨**main()**å‡½æ•°ä¹‹å‰æ‰§è¡Œè¯¥å‡½æ•°ï¼š

```c
__attribute__((constructor))
void dumptofile(int argc, const char **argv, const char **envp, const char **apple, struct ProgramVars *pvars)
```

è¿™æ®µä»£ç ä¸è§£çš„æ˜¯ï¼šå¦‚ä½•ç»™ ProgramVars ç»“æ„ä½“èµ‹å€¼çš„ï¼Ÿï¼ˆğŸ¤”ï¸æ²¡æ‰¾åˆ°ä»€ä¹ˆèµ„æ–™ï¼Œå…ˆè·³è¿‡

---

åœ¨ [dumpdecrypted - conradevçš„forkç‰ˆæœ¬](https://github.com/conradev/dumpdecrypted) çš„æºç ä¸­æ‰¾åˆ°äº†ç­”æ¡ˆï¼š

`__attribute__((constructor)) static void dumpexecutable()` ä¸­ç»™`_dyld_register_func_for_add_image` æ³¨å†Œå›è°ƒå‡½æ•° `image_added` ï¼š

```c
void dumptofile(const char *path, const struct mach_header *mh) {
	...
}

static void image_added(const struct mach_header *mh, intptr_t slide) {
	Dl_info image_info;
	int result = dladdr(mh, &image_info);
	dumptofile(image_info.dli_fname, mh);
}

__attribute__((constructor))
static void dumpexecutable() {
	_dyld_register_func_for_add_image(&image_added);
}
```

`_dyld_register_func_for_add_image` çš„å®šä¹‰å¦‚ä¸‹ï¼Œç®€å•æ¥è¯´å½“ dyld åŠ è½½æˆ–å¸è½½ç¨‹åºæ˜ åƒï¼ˆimageï¼‰éƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼š

```c
/*
 * The following functions allow you to install callbacks which will be called   
 * by dyld whenever an image is loaded or unloaded.  During a call to _dyld_register_func_for_add_image()
 * the callback func is called for every existing image.  Later, it is called as each new image
 * is loaded and bound (but initializers not yet run).  The callback registered with
 * _dyld_register_func_for_remove_image() is called after any terminators in an image are run
 * and before the image is un-memory-mapped.
 */
extern void _dyld_register_func_for_add_image(void (*func)(const struct mach_header* mh, intptr_t vmaddr_slide))    __OSX_AVAILABLE_STARTING(__MAC_10_1, __IPHONE_2_0);
extern void _dyld_register_func_for_remove_image(void (*func)(const struct mach_header* mh, intptr_t vmaddr_slide)) __OSX_AVAILABLE_STARTING(__MAC_10_1, __IPHONE_2_0);
```

äº‹å·²è‡³æ­¤å°±æ¥ç®€å•æ¢³ç†å†…æ ¸åŠ è½½åŠ å£³åçš„ MachOï¼Œå¤§è‡´çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š
![](../assets/images/dump-load-ipa.jpeg)

1. å†…æ ¸ç©ºé—´
    
    å†…æ ¸ç©ºé—´çš„ä¸»è¦ä»»åŠ¡æ˜¯åˆ›å»ºæ–° task å¹¶åˆå§‹åŒ–å†…å­˜é¡µå’Œå¯¹åº”çš„æƒé™ï¼š
    
    1. åˆ†é…è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚
    2. fork è¿›ç¨‹ã€‚
    3. åŠ è½½ MachO åˆ°è¿›ç¨‹ç©ºé—´ã€‚
    4. åŠ è½½åŠ¨æ€é“¾æ¥å™¨ dyld å¹¶å°†æ§åˆ¶æƒäº¤ç»™ dyld å¤„ç†ã€‚
2. ç”¨æˆ·ç©ºé—´
    
    ä»å†…æ ¸å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾¿è·³è½¬åˆ°ç›®æ ‡çš„å…¥å£åœ°å€å¼€å§‹æ‰§è¡ŒåŠ¨æ€é“¾æ¥é˜¶æ®µï¼Œè¿›å…¥ dyld åŠ¨æ€é“¾æ¥å™¨ï¼š
    
    1. é…ç½®ç¯å¢ƒå˜é‡
    2. åŠ è½½å…±äº«ç¼“å­˜åº“
    3. å®ä¾‹åŒ–ä¸»ç¨‹åº
    4. åŠ è½½åŠ¨æ€é“¾æ¥åº“
    5. é“¾æ¥ä¸»ç¨‹åº
    6. åŠ è½½Loadå’Œç‰¹å®šçš„C++çš„æ„é€ å‡½æ•°æ–¹æ³•
    7. å¯»æ‰¾APPçš„mainå‡½æ•°å¹¶è°ƒç”¨

æ‰€ä»¥å½“æœ‰imageè¢«åŠ è½½æ—¶éƒ½ä¼šè°ƒç”¨`_dyld_register_func_for_add_image` ä¼ å…¥çš„å›è°ƒå‡½æ•°ã€‚`dumptofile` å°†MachOæ–‡ä»¶è½¬å‚¨ï¼ŒæŠŠå…¶å‡½æ•°å†…å®¹æ­¥éª¤ç®€åŒ–ä¸€ä¸‹ï¼š

1ã€æå–Appæ–‡ä»¶å

```c
/* extract basename */
tmp = strrchr(rpath, '/');
printf("\n\n");
if (tmp == NULL)
{
	printf("[-] Unexpected error with filename.\n");
	_exit(1);
}
else
{
	printf("[+] Dumping %s\n", tmp + 1);
}
```

2ã€åˆ¤æ–­ `mach_header` æ˜¯64ä½è¿˜æ˜¯32ä½ï¼Œè®¡ç®— `load commands` æŒ‡é’ˆ

```c
/* detect if this is a arm64 binary */
if (mh->magic == MH_MAGIC_64)
{
	lc = (struct load_command *)((unsigned char *)mh + sizeof(struct mach_header_64));
	printf("[+] detected 64bit ARM binary in memory.\n");
}
else
{ /* we might want to check for other errors here, too */
	lc = (struct load_command *)((unsigned char *)mh + sizeof(struct mach_header));
	printf("[+] detected 32bit ARM binary in memory.\n");
}
```

3ã€åˆ¤æ–­ `LC_ENCRYPTION_INFO` æœªåŠ å¯†å°±ä¸­æ–­æ‰§è¡Œ

```c
/* searching all load commands for an LC_ENCRYPTION_INFO load command */
for (i = 0; i < mh->ncmds; i++)
{
	/*printf("Load Command (%d): %08x\n", i, lc->cmd);*/
	if (lc->cmd == LC_ENCRYPTION_INFO || lc->cmd == LC_ENCRYPTION_INFO_64)
	{
		eic = (struct encryption_info_command *)lc;
		/* If this load command is present, but data is not crypted then exit */
		if (eic->cryptid == 0)
		{
			break;
		}
...
```

4ã€å¾—åˆ° `cryptid` åç§»é‡

```
off_cryptid = (off_t)((void *)&eic->cryptid - (void *)mh);
printf("[+] offset to cryptid found: @%p(from %p) = %x\n", &eic->cryptid, mh, off_cryptid);
```

5ã€è¯»å–åŸMachO headerï¼Œåˆ¤æ–­ `FAT_CIGAM` å•¥çš„é‡å®šä½åˆ°çœŸæ­£çš„headeråœ°å€ï¼š

```c
printf("[+] Reading header\n");
n = read(fd, (void *)buffer, sizeof(buffer));
if (n != sizeof(buffer))
{
	printf("[W] Warning read only %d bytes\n", n);
}

printf("[+] Detecting header type\n");
fh = (struct fat_header *)buffer;

/* Is this a FAT file - we assume the right endianess */
if (fh->magic == FAT_CIGAM)
{
	printf("[+] Executable is a FAT image - searching for right architecture\n");
	...
}
else if (fh->magic == MH_MAGIC || fh->magic == MH_MAGIC_64)
{
	printf("[+] Executable is a plain MACH-O image\n");
}
else
{
	printf("[-] Executable is of unknown type\n");
	_exit(1);
}
```

6ã€å¾—åˆ°ç ¸å£³å†…å®¹è¾“å‡ºåˆ°æ–‡ä»¶

```c
...
/* calculate address of beginning of crypted data */
n = fileoffs + eic->cryptoff;

restsize = lseek(fd, 0, SEEK_END) - n - eic->cryptsize;
lseek(fd, 0, SEEK_SET);

printf("[+] Copying the not encrypted start of the file\n");
/* first copy all the data before the encrypted data */
while (n > 0)
{
	toread = (n > sizeof(buffer)) ? sizeof(buffer) : n;
	r = read(fd, buffer, toread);
	if (r != toread)
	{
		printf("[-] Error reading file\n");
		_exit(1);
	}
	n -= r;

	r = write(outfd, buffer, toread);
	if (r != toread)
	{
		printf("[-] Error writing file\n");
		_exit(1);
	}
}

/* now write the previously encrypted data */
printf("[+] Dumping the decrypted data into the file\n");
r = write(outfd, (unsigned char *)mh + eic->cryptoff, eic->cryptsize);
if (r != eic->cryptsize)
{
	printf("[-] Error writing file\n");
	_exit(1);
}

/* and finish with the remainder of the file */
n = restsize;
lseek(fd, eic->cryptsize, SEEK_CUR);
printf("[+] Copying the not encrypted remainder of the file\n");
while (n > 0)
{
	toread = (n > sizeof(buffer)) ? sizeof(buffer) : n;
	r = read(fd, buffer, toread);
	if (r != toread)
	{
		printf("[-] Error reading file\n");
		_exit(1);
	}
	n -= r;

	r = write(outfd, buffer, toread);
	if (r != toread)
	{
		printf("[-] Error writing file\n");
		_exit(1);
	}
}
...
```

ä¸»è¦åˆ†æˆä¸‰æ­¥ï¼š

- å¤åˆ¶æ–‡ä»¶å¤´æ•°æ®ï¼ˆheaderå¼€å§‹åˆ°eic->cryptoff
- å°†è§£å¯†æ•°æ®å†™å…¥æ–‡ä»¶ï¼ˆmh+eic->cryptoff å¼€å§‹å¤§å°ä¸º eic->cryptsize çš„å†…æ ¸è§£å¯†å¥½çš„æ•°æ®ï¼‰
- å°†æ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†ä¹Ÿå†™å…¥æ–‡ä»¶

7ã€ä¿®æ”¹åŠ å¯†æ ‡è¯†ä½

```
if (off_cryptid)
{
	uint32_t zero = 0;
	off_cryptid += fileoffs;
	printf("[+] Setting the LC_ENCRYPTION_INFO->cryptid to 0 at offset %x\n", off_cryptid);
	if (lseek(outfd, off_cryptid, SEEK_SET) != off_cryptid || write(outfd, &zero, 4) != 4)
	{
		printf("[-] Error writing cryptid value\n");
	}
}
```

åˆ°æ­¤ç ¸å£³è¿‡ç¨‹å°±ç»“æŸå•¦ã€‚

### ç¼–è¯‘&æµ‹è¯•

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`$ make` ç”Ÿæˆ`dumpdecrypted.dylib`ï¼š
![](../assets/images/dump-dumpdecrypted-dylib.png)

æ‹·è´åˆ° iPhone ä¸­ï¼Œè¿è¡Œ `DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib Foo.App/Foo` å‡ºç° `missing LC_DYLD_INFO load command` çš„é”™è¯¯ï¼Œè¦å°†xcode iPhone sdkçš„ç‰ˆæœ¬ä¸è¶Šç‹±æœºå™¨çš„ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œæˆ‘çš„æµ‹è¯•æœºä¸º `iPhone 6 Plus` `iOS 12.5.5` è¦ä¸‹ä¸ª iOS12.* çš„sdkï¼Œè¾£é¸¡ [xcodeå’Œsdkä¹‹é—´æ˜¯ç»‘å®š](https://stackoverflow.com/questions/34876144/where-to-download-an-slightly-older-ios-sdk/34876416#34876416)çš„ï¼Œéœ€è¦ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„xcodeï¼Œå†[æŠŠsdkæ·»åŠ åˆ°å½“å‰xcode](https://stackoverflow.com/a/13061104)å°±è¡Œäº†ï¼ˆğŸ˜¢ä¸€è¾¹ä¸‹è½½ä¸€è¾¹æµ‹è¯•ä¸‹å…¶ä»–å·¥å…·å§ã€‚

## Clutch

ä¸‹è½½æ‰§è¡Œæ–‡ä»¶ï¼š[https://github.com/KJCracks/Clutch/releases](https://github.com/KJCracks/Clutch/releases) æ‹·è´åˆ°æµ‹è¯•æœºä¸­ï¼Œè¿è¡Œ `Clutch -b xxx.xxx.xxx` åˆæŠ¥é”™å•¦ï¼š`Error: Failed to dump with arch arm64` ã€‚å¥½åœ¨ç¿»åˆ°ä¸€æ¡issue: [KJCracks/Clutch/issues/233](https://github.com/KJCracks/Clutch/issues/233) ç»™Clutchæ·»åŠ äº›æƒé™å°±å¥½äº†ï¼ˆåœ¨æˆ‘çš„æ–‡ç« [macOSååè°ƒè¯•å°è®°](https://blog.macoder.tech/article/macos-anti-anti-debug) ä¸­ä¹Ÿæœ‰è®°å½•æ“ä½œæ­¥éª¤ï¼‰ï¼š

```xml
<key>platform-application</key>
<true/>
<key>get-task-allow</key>
<true/>
<key>run-unsigned-code</key>
<true/>
<key>com.apple.private.skip-library-validation</key>
<true/>
<key>com.apple.private.security.no-container</key>
<true/>
```

okï¼ä½¿ç”¨å‘½ä»¤ï¼š`./Clutch -b [xxx.xxx.xxx Bundle ID]`  å¼€å§‹ç ¸å£³å§ï¼

## frida-ios-dump

1. å®‰è£…[frida](/2-å·¥å…·å‡†å¤‡/2/#frida)
2. å…‹éš†ä»£ç &å®‰è£…ä¾èµ–ï¼š

```bash
git clone https://github.com/AloneMonkey/frida-ios-dump
pip3 install -r frida-ios-dump/requirements.txt
```
3. å®‰è£…[usbmuxd](/2-å·¥å…·å‡†å¤‡/1/#_5)

okï¼ä½¿ç”¨å‘½ä»¤ï¼š`python3 dump.py [App Name]`  å¼€å§‹ç ¸å£³å§ï¼

## CrackerXI+

1. æ·»åŠ è½¯ä»¶æº&å®‰è£…CrackerXI+

- Cydiaè½¯ä»¶æºï¼š`https://cydia.iphonecake.com/`
- å®‰è£…CrackerXI+

![](../assets/images/dump-crackerxi-installed.jpg)

2. ç ¸å£³

æ‰“å¼€ `CrackerXI HOOK` è®¾ç½®ï¼Œé€‰æ‹© App è¿›è¡Œç ¸å£³ï¼Œæ­¥éª¤éå¸¸ç®€å•ï¼š
![](../assets/images/dump-crackerxi.jpg)


## æ€»ç»“

è¿™å‡ ä¸ªå·¥å…·ç”¨æ¥ä¸‹ï¼Œæ¨è `CrackerXI`å’Œ`frida-ios-dump` ç ¸å£³æ•ˆæœéƒ½è¿˜ä¸é”™ï¼Œ`dumpdecrypted` è¦åŒ¹é…iOSç‰ˆæœ¬ä¸‹è½½å¯¹åº”çš„SDKç¼–è¯‘éº»çƒ¦ï¼Œ`Clutch` ç ¸å£³æ•ˆæœä¸å’‹åœ°ã€‚

å…ˆæ°´åˆ°è¿™ï¼Œè¿˜æœ‰ `frida-ios-dump` å’Œ `clutch` æºç æ²¡ç ”ç©¶ï¼ŒåŸç†ä¼°è®¡éƒ½å·®ä¸å¤šï¼Œè¯»å–å†…æ ¸è§£å¯†åçš„å†…å®¹å¹¶è®¡ç®—å…¶åç§»ä½ç½®å°†å…¶ä»å†…å­˜ä¸­æ‹·è´å‡ºæ¥ã€‚

## å‚è€ƒé“¾æ¥

- [Fairplay DRMä¸æ··æ·†å®ç°çš„ç ”ç©¶](https://tech.meituan.com/2021/11/25/fairplay-drm.html)
- [iOS-Pentest-Tools](https://trelis24.github.io/2018/03/11/iOS-Pentest-Tools/)
- [Understanding the iOS File System](https://medium.com/@lucideus/understanding-the-ios-file-system-eee3dc87e455)
- [ä¸€æ¡å‘½ä»¤å®Œæˆç ¸å£³](http://blog.alonemonkey.com/2018/01/30/frida-ios-dump/)
- [dumpdecrypted](https://github.com/stefanesser/dumpdecrypted)
- [__attribute__((constructor)) and __attribute__((destructor)) syntaxes in C](https://www.geeksforgeeks.org/__attribute__constructor-__attribute__destructor-syntaxes-c/)
- [æ·±å…¥æµ…å‡ºMachO](https://evilpan.com/2020/09/06/macho-inside-out/)
- [ç ¸å£³åŸç†ä¹‹dumpdecrypted](https://benarvintec.com/2019/06/20/iOS%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%E7%A0%B8%E5%A3%B3%E5%8E%9F%E7%90%86%E4%B9%8Bdumpdecrypted/)
- [apple-oss-distributions/dyld](https://github.com/apple-oss-distributions/dyld)
- [iOS åº”ç”¨çš„å¯åŠ¨è¿‡ç¨‹](http://www.samirchen.com/ios-app-launching/)
- [iOSé€†å‘(5)-ä¸çŸ¥MachOæ€æ•¢è¯´è‡ªå·±æ‡‚DYLD](https://juejin.cn/post/6844903798717022222)
- [iOSé€†å‘(11)-ç ¸å£³åŸç†å‰–æï¼Œä¸»åŠ¨åŠ è½½æ‰€æœ‰framework](https://juejin.cn/post/6844904006024691726)
- [Frida-ios-dumpä¸€é”®ç ¸å£³èœé¸¡ç‰ˆ](https://iosre.com/t/frida-ios-dump/11640)